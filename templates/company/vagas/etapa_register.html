{%load static%}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/company/etapa_register.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link href="{% static 'fontawesomefree/css/fontawesome.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'fontawesomefree/css/brands.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'fontawesomefree/css/solid.css' %}" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="{% static 'css/utils/pnotify.custom.min.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="{% static 'js/jquery.mask.min.js' %}"></script>
    <script src="{% static 'js/pnotify.custom.min.js' %}"></script>
    <title>Cadastro Vagas</title>
</head>
<body>
    <div class="div-icon-accessibility">
        <i class="fa-sharp fa-solid fa-universal-access"></i>
    </div>

    <div class="body">
        <div class="form-div">
            <div class="add-etapa">
                <p class="p-title1">Cadastro de Etapas</p>
                <label for="etapas">Etapas:</label>
                <button class="button-etp" data-toggle="modal" data-target="#modalEtapa">Adicionar</button>
                <hr>
            </div>
            <div class="div-content">
                <div class="div-etapas-cadastradas">
                    <div class="etapas-cadastradas" id="etapas-cadastradas">
                        {% for step in steps %}
                        <div id="step-{{step.id}}">
                            <p class="etapa-title">{{step.step}} - {{step.title}}</p>
                            <div class="div-row">
                                <div class="div-column">
                                    <p class="etapa-text">Tipo da etapa: {{step.step_type}}</p>
                                    <p class="etapa-text">Etapa será feita de forma {{step.step_modality}}</p>
                                    <p class="etapa-text">Etapa será aplicada para {{step.step_vulnerability}}</p>
                                </div>
                                <div class="div-description-icon">
                                    <p class="etapa-text description">Descrição da etapa: {{step.description}}</p>
                                    <div class="buttons-icon">
                                        <a onclick="getStep('{{step.id}}')" class="icon-several"><i class="fa-solid fa-pen"></i></a>
                                        <a onclick="deleteStep('{{step.id}}')" class="icon-several icon-trash"><i class="fa-solid fa-trash"></i></a>
                                    </div>
                                </div>
                            </div>
                            <hr class="linha">
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="div-button">
                    <a href="{% url 'exibir_vagas' id=id_company id_vacancy=id_vacancy %}" class="button">Finalizar</a>
                </div>
            </div>
        </div>

        {% block modal%}
        {% include "company/vagas/etapa_register_modal.html" %}
        {% endblock modal %}
    </div>
</body>

<script>
    var url = "/api/vagas/{{id_vacancy}}/step";
    var type = 'post';

    function getStep(step_id){
        $.ajax({
            type: 'get',
            url: `/api/vagas/${step_id}/step`,
            headers: { "Content-Type": "application/json; charset=UTF-8","X-CSRFToken": '{{csrf_token}}' },
            success: function (retorno) {
                response = retorno.detail
                $('#step').val(response['step'])
                document.getElementById("title").value = response['title']
                document.getElementById("description").value = response['description']
                $('#company').val(response['company'])
                document.getElementById("step_modality").value = response['step_modality']
                document.getElementById("step_vulnerability").value = response['step_vulnerability']
                document.getElementById("step_type").value = response['step_type']

                url = `/api/vagas/${response['id']}/step`
                type = 'put'

                $('#modalEtapa').modal('show')

            },
            error: function (error) {
                if (error.statusText == 'timeout') {
                    new PNotify({
                        title: 'Requisição Cancelada',
                        text: 'Requisição ao serviço cancelada. Tente novamente em alguns minutos.',
                        type: 'error',
                        delay: '5000'
                    });
                }

                console.log(error);
            }
        });
    }

    $('#form').submit(function(event){
        event.preventDefault()

        if (type == 'post'){
            createStep()
        } else {
            updateStep()
        }

    })

    function createStep() {
        var stepModalitySelect = document.getElementById("step_modality");
        var stepVulnerabilitySelect = document.getElementById("step_vulnerability");

        const data = {
            'step': $("#step").val(),
            'title': $("#title").val(),
            'step_modality': stepModalitySelect.options[stepModalitySelect.selectedIndex].value,
            'step_type': $("#step_type").val(),
            'step_vulnerability': stepVulnerabilitySelect.options[stepVulnerabilitySelect.selectedIndex].value,
            'description': $("#description").val(),
        }

        $.ajax({
            url: url,
            dataType: 'json',
            headers: { "Content-Type": "application/json; charset=UTF-8","X-CSRFToken": '{{csrf_token}}' },
            data: JSON.stringify(data),
            type: type,
            // contentType: false,
            // processData: false,
            success: function(response){
                var step = response.step
                
                var stepDiv = $('#etapas-cadastradas')

                text = `
                <div id="step-${step.id}">
                    <p class="etapa-title">${step.step} - ${step.title}</p>
                    <div class="div-row">
                        <div class="div-column">
                            <p class="etapa-text">Tipo da etapa: ${step.step_type}</p>
                            <p class="etapa-text">Etapa será feita de forma ${step.step_modality}</p>
                            <p class="etapa-text">Etapa será aplicada para ${step.step_vulnerability}</p>
                        </div>
                        <div class="div-description-icon">
                            <p class="etapa-text description">Descrição da etapa: ${step.description}</p>
                            <div class="buttons-icon">
                                <a onclick="getStep('${step.id}')" class="icon-several"><i class="fa-solid fa-pen"></i></a>
                                <a onclick="deleteStep('${step.id}')" class="icon-several icon-trash"><i class="fa-solid fa-trash"></i></a>
                            </div>
                        </div>
                    </div>
                    <hr class="linha">
                </div>
                `
                stepDiv.append(text)

                $('#modalEtapa').modal('hide')

                new PNotify({
                    title:'Etapa criada',
                    text: response.detail,
                    type: 'success',
                    delay:'5000'
                });
            },
            error: function(response){
                console.log(response)
            }
        })
    }

    function updateStep(){
        var stepModalitySelect = document.getElementById("step_modality");
        var stepVulnerabilitySelect = document.getElementById("step_vulnerability");

        const data = {
            'step': $("#step").val(),
            'title': $("#title").val(),
            'step_modality': stepModalitySelect.options[stepModalitySelect.selectedIndex].value,
            'step_type': $("#step_type").val(),
            'step_vulnerability': stepVulnerabilitySelect.options[stepVulnerabilitySelect.selectedIndex].value,
            'description': $("#description").val(),
        }

        $.ajax({
            url: url,
            dataType: 'json',
            headers: { "Content-Type": "application/json; charset=UTF-8","X-CSRFToken": '{{csrf_token}}' },
            data: JSON.stringify(data),
            type: type,
            contentType: false,
            processData: false,
            success: function(response){
                var step = response.step
                
                var stepDiv = document.getElementById(`step-${step.id}`)

                text = `
                <p class="etapa-title">${step.step} - ${step.title}</p>
                <div class="div-row">
                    <div class="div-column">
                        <p class="etapa-text">Tipo da etapa: ${step.step_type}</p>
                        <p class="etapa-text">Etapa será feita de forma ${step.step_modality}</p>
                        <p class="etapa-text">Etapa será aplicada para ${step.step_vulnerability}</p>
                    </div>
                    <div class="div-description-icon">
                        <p class="etapa-text description">Descrição da etapa: ${step.description}</p>
                        <div class="buttons-icon">
                            <a onclick="getStep('${step.id}')" class="icon-several"><i class="fa-solid fa-pen"></i></a>
                            <a onclick="deleteStep('${step.id}')" class="icon-several icon-trash"><i class="fa-solid fa-trash"></i></a>
                        </div>
                    </div>
                </div>
                <hr class="linha">
                `
                stepDiv.innerHTML = text

                $('#modalEtapa').modal('hide')

                new PNotify({
                    title:'Etapa atualizada',
                    text: response.detail,
                    type: 'success',
                    delay:'5000'
                });
            },
            error: function(response){
                console.log(response)
            }
        })
    }

    function deleteStep(step_id){
        $.ajax({
            type: 'delete',
            url: `/api/vagas/${step_id}/step`,
            headers: { "Content-Type": "application/json; charset=UTF-8","X-CSRFToken": '{{csrf_token}}' },
            success: function (retorno) {
                var el = document.getElementById("etapas-cadastradas");
                var stepDiv = document.getElementById(`step-${step_id}`);
                el.removeChild(stepDiv);

                new PNotify({
                    title:'Etapa excluída',
                    text: retorno.detail,
                    type: 'success',
                    delay:'5000'
                });
            },
            error: function (error) {
                if (error.statusText == 'timeout') {
                new PNotify({
                    title: 'Requisição Cancelada',
                    text: 'Requisição ao serviço cancelada. Tente novamente em alguns minutos.',
                    type: 'error',
                    delay: '5000'
                });
                }

                console.log(error);
            }
        });
    }



</script>
</html>